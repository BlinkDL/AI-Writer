<!DOCTYPE html>
<html>

<head>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?1e834a9b11dc71db3d0ae4cbb885253d";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm/dist/tf-backend-wasm.js"></script>
    <script>
        tf.setBackend('wasm');
    </script>
</head>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>AIæ™ºéšœå†™ä½œ</title>
</head>
<style>
    * {
        margin: 0px;
        padding: 0px;
    }

    body {
        background-color: #ffd;
        /* background-color: #cfc; */
        overflow-y: scroll;
        color: #000;
        font-family: "Hiragino Sans GB", "Microsoft Yahei", sans-serif;
        margin: 0.2em;
    }

    a:link {
        color: inherit;
    }

    a {
        color: inherit;
    }

    a:hover {
        color: #f00 !important;
    }

    a:visited {
        color: inherit;
    }

    #textArea,
    #logArea {
        font-family: "Hiragino Sans GB", "SimHei", sans-serif;
        line-height: 1.5;
        font-size: 100%;
        height: 70vh;
        padding: 0.3em;
        width: 100%;
        box-sizing: border-box;
    }

    #logArea {
        font-size: 70%;
        background-color: #ddd;
        line-height: 1;
    }

    #textWrap {
        margin: 0 auto;
    }

    .writeBtn {
        width: 45%;
        height: 2em;
        cursor: pointer;
    }
</style>

<body>
    <div style="text-align: center; line-height: 1.5; font-size: 80%;">
        <p>AIæ™ºéšœå†™ä½œ <a href="https://zhuanlan.zhihu.com/p/487278175" target="_blank">é‡‡ç”¨æˆ‘çš„RWKV-v2-RNNæ¨¡å‹ï¼Œæ¯”GPTé«˜æ•ˆï¼Œç‚¹å‡»çœ‹æˆ‘çŸ¥ä¹äº†è§£</a>
            è¿™æ˜¯ç®€åŒ–ç‰ˆï¼Œ<a href="https://github.com/BlinkDL/AI-Writer" target="_blank">Githubç‰ˆæ›´å¼º</a> è¯·ç»å¸¸å¤‡ä»½å†…å®¹ <a
                href="https://t.me/ai_writer" target="_blank">TGç¾¤</a> è¯·ç”¨Chromeå†™å¾—æœ€å¿« <span
                style="color:blue; font-weight: bold;">ç”µè„‘æ˜¯æ™ºéšœï¼Œä»…ä¾›å¨±ä¹ï¼Œè¯·éµå®ˆæ³•å¾‹æ³•è§„</span></p>
    </div>
    <div id="textWrap">
        <div style="min-height:2em">
            <div id="loading" style="color:blue; font-size: 120%; text-align: center;">
                æ­£åœ¨è¯»å–æ¨¡å‹ <span id="loadprog"></span>ï¼Œæ¨¡å‹åœ¨ <a href="https://github.com/BlinkDL/AI-Writer"
                    target="_blank">Github å¤–ç½‘</a>ï¼Œè¯·æ‰¾æ–¹æ³•åŠ é€Ÿã€‚è¯»å–å®Œå°±ä¼šæœ‰ç»­å†™æŒ‰é’®ã€‚
            </div>
            <div id="writeBtns"
                style="width: 100%; display: none; margin-bottom:0.5em; flex-direction:row; justify-content:space-evenly;">
                <button class="writeBtn" onclick="sendText()">ç»­å†™ (alt+Q)</button>
                <button class="writeBtn" onclick="rewriteText()">æ¢ä¸ªå†™æ³• (alt+E)</button>
                <select onchange="WRITE_EACH_LENGTH = parseInt(this.options[this.selectedIndex].text.split('å†™')[1])">
                    <option>æ¯æ¬¡å†™30</option>
                    <option>æ¯æ¬¡å†™50</option>
                    <option>æ¯æ¬¡å†™75</option>
                    <option>æ¯æ¬¡å†™100</option>
                    <option>æ¯æ¬¡å†™200</option>
                    <option>æ¯æ¬¡å†™300</option>
                    <option selected>æ¯æ¬¡å†™500</option>
                    <option>æ¯æ¬¡å†™1000</option>
                    <option>æ¯æ¬¡å†™2000</option>
                    <option>æ¯æ¬¡å†™3000</option>
                    <option>æ¯æ¬¡å†™5000</option>
                    <option>æ¯æ¬¡å†™9999</option>
                </select>
            </div>
        </div>
        <div style="display:flex; flex-direction:row; justify-content:space-evenly;">
            <textarea id="textArea" style="flex: 2 1 0">é‡‘è‰²</textarea>
            <textarea id="logArea" style="flex: 1 1 0">è¯·åœ¨å·¦è¾¹å†™ä½œã€‚å³è¾¹è¿™é‡Œæ˜¯æš‚å­˜åŒºåŸŸï¼Œä¼šçºªå½•æ¯æ¬¡çš„ç»­å†™å†…å®¹ï¼Œä¾›ä½ å‚è€ƒã€‚è¯·å®šæœŸæ¸…ç©ºè¿™é‡Œï¼Œä»¥å…æ‹–æ…¢é€Ÿåº¦ã€‚</textarea>
        </div>
    </div>
    <div style="margin:0 auto 10em auto; text-align:center;">
        <div><span id="model_version"></span> ä»£ç  20220410ï¼Œè§£å†³äº†é‡å¤ã€‚æ³¨æ„å†™é•¿ä»ä¼šè¶Šå†™è¶Šå·®</div>
        <div>å¦‚æœå–œæ¬¢ï¼Œè¯·æ”¯æŒé¡¹ç›®ğŸ˜ƒï¼ˆæ‰«ä¸‹é¢ç ï¼‰æ¬¢è¿åˆ†äº«ã€åˆä½œã€‚è¯·çœ‹<a href="https://withablink.taobao.com/"
                target="_blank">ã€æˆ‘ä»¬æ·˜å®åº—ã€‘</a>æœ‰ä¼˜è´¨é«˜æ˜¾è‰²æŠ¤çœ¼LEDç¯</div>
        <img style="max-width:50vw" src="https://mapp.alicdn.com/1648992731802nKnFWrIV085In7P.png">
        <div style="line-height: 1.5;">
            <div>è¯·å®šæœŸæ¸…ç©ºå³è¾¹åŒºåŸŸï¼Œä»¥å…æ‹–æ…¢é€Ÿåº¦ã€‚å¦‚æœå­—ä½“å°ï¼Œå¯æ”¾å¤§ç½‘é¡µã€‚</div>
            <div style="margin: 1em 0">ä½¿ç”¨åˆ›æ„å¼€å¤´ï¼š<select id="set_prompt"
                    onchange="setPrompt(this.options[this.selectedIndex].text)">
                    <option>è¯·é€‰æ‹©</option>
                    <option>ææ€–</option>
                    <option>ç»ç¾</option>
                    <option>æš—é»‘</option>
                    <option>é“¶ç™½</option>
                    <option>é‡‘è‰²</option>
                    <option>è¡€çº¢</option>
                    <option>ç¿ ç»¿</option>
                    <option>ç½—é©¬</option>
                    <option>æ™ºèƒ½</option>
                    <option>æ˜Ÿèˆ°</option>
                    <option>é­”æ³•</option>
                    <option>å°‘å¥³</option>
                    <option>â€œé“å‹</option>
                    <option>â€œåŒºåŒº</option>
                    <option>â€œæ­å–œ</option>
                    <option>åå¹´</option>
                    <option>ä¸€ç™¾å¹´</option>
                    <option>ä¸€åƒå¹´</option>
                    <option>ç¥åœ£</option>
                    <option>ç„å¥¥</option>
                    <option>æ˜æš—</option>
                    <option>é›ªç™½</option>
                    <option>è”šè“</option>
                    <option>ç‹‚æš´</option>
                    <option>é­”ç¥</option>
                    <option>é­”å…½</option>
                    <option>å…½äºº</option>
                    <option>å¤œè‰²</option>
                    <option>æ¢¦å¹»</option>
                    <option>å†°å°</option>
                    <option>ä¼ è¯´</option>
                    <option>è¿œå¤</option>
                    <option>ä¸Šå¤</option>
                    <option>çµè„‰</option>
                    <option>çµæ°”</option>
                    <option>çµçŸ³</option>
                    <option>çœŸæ°”</option>
                    <option>é­”åŠ›</option>
                </select> ä¼šå°†å·¦è¾¹å†…å®¹ç§»åˆ°å³è¾¹ï¼
            </div>
            <div style="margin: 1em 0"><select
                    onchange="TOP_P = parseFloat(this.options[this.selectedIndex].text.split('åº¦')[1])">
                    <option>éšæœºåº¦0</option>
                    <option>éšæœºåº¦0.3</option>
                    <option>éšæœºåº¦0.5</option>
                    <option>éšæœºåº¦0.7</option>
                    <option>éšæœºåº¦0.75</option>
                    <option selected>(é»˜è®¤)éšæœºåº¦0.8</option>
                    <option>éšæœºåº¦0.85</option>
                    <option>éšæœºåº¦0.9</option>
                    <option>éšæœºåº¦0.95</option>
                    <option>éšæœºåº¦1</option>
                </select> éšæœºåº¦è¶Šé«˜ï¼Œå†…å®¹è¶Šä¸°å¯Œä½†é€»è¾‘å˜å·®ã€‚</div>
            <div>åœ¨Githubæœ‰<a href="https://github.com/BlinkDL/AI-Writer" target="_blank">æ›´å¼ºçš„æ¨¡å‹</a>ï¼Œä»¥åŠ<a
                    href="https://github.com/BlinkDL/RWKV-LM" target="_blank">è®­ç»ƒä»£ç </a>ï¼Œå¯è®­ç»ƒè‡ªå·±çš„è¯­æ–™ã€‚ä¸æ‡‚å¯ä»¥åŠ <a
                    href="https://t.me/ai_writer" target="_blank">TGç¾¤</a>ã€‚</div>
        </div>
        <div style="line-height: 2; text-align: left; margin:1em;">
            FAQï¼š
            <br>*)
            ä¸ºä»€ä¹ˆå†™é•¿äº†ä¼šå˜å·®ï¼Ÿç­”ï¼šå› ä¸ºè¿™æ˜¯6å±‚512åµŒå…¥çš„è¿·ä½ 26Må‚æ•°æ¨¡å‹ï¼ˆæ‰€ä»¥ç”µè„‘ç¬¨ï¼Œä½†å†™å¾—å¿«ï¼‰ã€‚å»ºè®®æ¯æ¬¡åªå†™å‡ ç™¾å­—ï¼Œ<span
                style="color:blue; font-weight: bold;">å‘ç°æ··ä¹±æ–‡å­—æ—¶ï¼Œå¿…é¡»åˆ é™¤æ··ä¹±çš„å†…å®¹å†ç»­å†™ï¼Œå¦åˆ™è¶Šå†™è¶Šæ··ä¹±ã€‚</span>åœ¨Githubæœ‰12å±‚768åµŒå…¥çš„æ ‡å‡†æ¨¡å‹ï¼Œæ•ˆæœæ›´å¥½ã€‚å°æ¢¦æ¨¡å‹æ¯”è¿™ä¸ªå¤§å‡ ç™¾å€ï¼Œæ¨¡å‹è¶Šå¤§ï¼Œé€»è¾‘è¶Šå¥½ï¼Œè®­ç»ƒè€—èµ„è¶Šé«˜ï¼Œæ‰€ä»¥æ¬¢è¿å¤§å®¶æ”¯æŒé¡¹ç›®ï¼Œä»¥ç‚¼æ›´å¤§çš„æ•ˆæœæ›´å¥½çš„æ¨¡å‹ï¼ˆå¾—ç‚¼å‡ ä¸ªæœˆï¼‰ã€‚
            <br>*) æ˜¯ç”¨ä»€ä¹ˆè®­ç»ƒï¼Ÿç­”ï¼šç”¨pytorchè®­ç»ƒï¼Œç”¨tf.jséƒ¨ç½²ã€‚ç”¨äº†200Gè¯­æ–™ï¼Œ80%æ˜¯ç½‘æ–‡ã€‚
            <br>*) å¯ä»¥å†™åˆ˜å¤‡å—ï¼Ÿç­”ï¼šå¯ç”¨Githubä»£ç è‡ªå·±è®­ç»ƒã€‚ä¸æ‡‚å¯ä»¥åŠ <a href="https://t.me/ai_writer"
                target="_blank">TGç¾¤</a>ã€‚ç°åœ¨ä½ èƒ½è¯±å¯¼å®ƒå†™æ“¦è¾¹çƒï¼ˆæœ‰æ—¶å®ƒè‡ªå·±ä¹Ÿä¼šå†™ï¼‰ï¼Œä¸è¿‡ï¼Œè®­ç»ƒå†…å®¹æ²¡Hæ–‡ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå¼€éœ²éª¨çš„è½¦ã€‚
            <br>*) ä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šå†’å‡ºæ¥â€œç¬¬xxç« â€ï¼Ÿç­”ï¼šå› ä¸ºè®­ç»ƒæ–‡æœ¬æ²¡å»é™¤ç« èŠ‚æ ‡è®°ï¼Œä½†å®ƒç”Ÿæˆçš„xxç« éƒ½æ˜¯çç¼–çš„ï¼Œä½ æ‰¾ä¸åˆ°å‡ºå¤„çš„ã€‚
            <div style="line-height: 1.5;">
                <br>æ¨¡å‹åŸç†ï¼ˆä»¥Githubçš„12å±‚768åµŒå…¥æ¨¡å‹ä¸ºä¾‹ï¼‰
                <br>ç”µè„‘çš„åŸç†ï¼Œæ˜¯é¢˜æµ·æˆ˜æœ¯+ç¬¨é¸Ÿå…ˆé£ã€‚å®ƒæŠŠå­—å˜æˆå¾ˆå¤šæ•°ï¼Œç„¶åï¼Œæ‰¾è¿™äº›æ•°çš„æ•°å­¦ï¼ˆç»Ÿè®¡å­¦ï¼‰è§„å¾‹ã€‚
                <br>
                <br>ç”µè„‘çš„å­¦ä¹ ç›®æ ‡ï¼šè¾“å…¥ä¸€å †å­—ï¼Œé¢„æµ‹ä¸‹ä¸€ä¸ªå­—ã€‚
                <br>åªè¦å­¦ä¼šè¿™ä¸ªï¼Œå°±å¯ä»¥ä¸€ä¸ªä¸ªå­—å†™ä¸‹å»ã€‚
                <br>è®­ç»ƒçš„å°è¯´æœ‰å‡ ä¸‡æœ¬ï¼Œæ¯æ¬¡éšæœºæŒ‘ä¸€æ®µ 512 ä¸ªå­—è¾“è¿›å»ï¼Œè®©ç”µè„‘çŒœä¸‹ä¸€ä¸ªå­—ï¼Œçœ‹æ˜¯å¦èƒ½çŒœå¯¹ã€‚
                <br>ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸æ–­è€ƒè¯•ã€‚
                <br>ä½ å¯ä»¥è‡ªå·±ç©è¿™ä¸ªæ¸¸æˆï¼ˆé®ä½åæ–‡ï¼ŒçŒœä¸‹ä¸€ä¸ªå­—ï¼‰ï¼Œä¼šå‘ç°ï¼Œéœ€è¦ç†è§£å‰æ–‡æ‰èƒ½ç©å¯¹ã€‚
                <br>
                <br>æˆ‘çš„å°æ¨¡å‹ï¼Œæ”¯æŒ 8849 ç§å­—ã€‚æ¯ä¸ªå­—å¯¹åº”ä¸¤ç»„æ•°ï¼Œæ¯ç»„æœ‰ 768 ä¸ªæ•°ã€‚
                <br>ä¾‹å¦‚ï¼š"æˆ‘" = ã€0.123 -1.534 ...ã€‘ï¼Œã€-0.827 2.343 ...ã€‘ï¼Œä¸å¦¨ç§°ä¸ºã€è¾“å…¥ç»„ã€‘å’Œã€è¾“å‡ºç»„ã€‘ã€‚
                <br>å¤§æ¨¡å‹ï¼Œæ¯ä¸ªå­—ä¼šå¯¹åº”å‡ åƒå‡ ä¸‡ä¸ªæ•°ã€‚
                <br>
                <br>ç¬¬ä¸€ï¼Œç¼–ç ã€‚
                <br>æ¯ä¸ªå­—æ ¹æ®å®ƒçš„ã€è¾“å…¥ç»„ã€‘ï¼Œå˜æˆ 768 ä¸ªæ•°ï¼Œæ¯ä¸ªæ•°ä»£è¡¨æŸç§éšè—å«ä¹‰ã€‚
                <br>ä¸¾ä¾‹ï¼Œæ¯ä¸ªå­—çš„ç¬¬Aä¸ªæ•°ä»£è¡¨"å¥½-å"ç»´åº¦ï¼Œç¬¬Bä¸ªæ•°ä»£è¡¨"åè¯-éåè¯"ç»´åº¦ï¼Œç­‰ç­‰ã€‚
                <br>å®é™…æ‰¾åˆ°çš„ç¼–ç ï¼Œä¸ä¸€å®šæœ‰å®¹æ˜“æè¿°çš„ç»´åº¦å«ä¹‰ã€‚
                <br>å› ä¸ºå…·ä½“çš„ç¼–ç ï¼Œæ˜¯ç”µè„‘è‡ªåŠ¨å»å‘ç°ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚
                <br>
                <br>æœ€åˆæ˜¯éšæœºç¼–ç ã€‚ç”µè„‘ä¼šä¸æ–­ç”¨ã€æ±‚å¯¼æ•°ã€‘çš„æ–¹æ³•è®¡ç®—ï¼Œä¿®æ”¹ç¼–ç ï¼Œæ”¹è¿›é¢„æµ‹ç»“æœã€‚
                <br>å¤§è‡´å¯ä»¥è®¤ä¸ºï¼šå¦‚æœç”µè„‘å‘ç°ï¼ŒæŠŠæŸä¸ªå­—çš„ç¬¬æŸä¸ªæ•°å¢åŠ  0.001ï¼Œå¯ä»¥æ”¹è¿›é¢„æµ‹ç»“æœï¼Œå®ƒå°±å»åšè¿™ä¸ªäº‹ã€‚
                <br>å› ä¸ºé¢„æµ‹ç»“æœæ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å®¢è§‚æ ‡å‡†ã€‚æ‰€ä»¥å®ƒåªè¦ä¸æ–­è¿™é‡Œ+0.001ï¼Œé‚£é‡Œ-0.001ï¼Œå°±æ…¢æ…¢æ¥è¿‘ç›®æ ‡ã€‚
                <br>æ€»ä¹‹ï¼Œè¾“å…¥ 512 ä¸ªå­—ï¼Œä¼šå˜æˆ 512*768 = 393216 ä¸ªæ•°ã€‚
                <br>
                <br>ç¬¬äºŒï¼Œæ¨¡å‹ä¼šæŠŠè¿™ 393216 ä¸ªæ•°ç»è¿‡ä¸€ç•ªè¿ç®—ï¼ˆå’Œå¦å¤–å‡ åƒä¸‡ä¸ªæ•°åšè¿ç®—ï¼Œè¿™å‡ åƒä¸‡ä¸ªæ•°ä¼šæ ¹æ®å‰æ–‡ä¸æ–­è°ƒæ•´ï¼‰ï¼Œæœ€ç»ˆå¾—åˆ° 768 ä¸ªæ•°ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æœ€æœ‰è¶£çš„ï¼Œç¨åä¹Ÿå¯ä»¥è§£é‡Šã€‚
                <br>
                <br>ç¬¬ä¸‰ï¼Œå°† 768 ä¸ªæ•°ï¼Œä¸ 8849 ç§å­—çš„ã€è¾“å‡ºç»„ã€‘æ¯”è¾ƒï¼Œè®¡ç®—å’Œæ¯ä¸ªå­—çš„æ¥è¿‘ç¨‹åº¦ï¼Œå°±æ˜¯è¾“å‡ºè¿™ä¸ªå­—çš„æ¦‚ç‡ã€‚
            </div>
        </div>
    </div>
</body>
<script>
    "use strict";
    const gParam = {}

    const n_layer = 6
    const n_embd = 512
    const ctx_len = 768
    const vocab_size = 8849

    var WRITE_EACH_LENGTH = 500
    var TOP_P = 0.8

    var weightName = [
        'emb.weight',
        'blocks.0.ln1.weight',
        'blocks.0.ln1.bias',
        'blocks.0.ln2.weight',
        'blocks.0.ln2.bias',
        'blocks.0.ffnPre.time_mix',
        'blocks.0.ffnPre.key.weight',
        'blocks.0.ffnPre.receptance.weight',
        'blocks.0.ffnPre.value.weight',
        'blocks.0.ffn.time_mix',
        'blocks.0.ffn.key.weight',
        'blocks.0.ffn.receptance.weight',
        'blocks.0.ffn.value.weight',
        'blocks.1.ln1.weight',
        'blocks.1.ln1.bias',
        'blocks.1.ln2.weight',
        'blocks.1.ln2.bias',
        'blocks.1.att.time_decay',
        'blocks.1.att.time_first',
        'blocks.1.att.time_mix',
        'blocks.1.att.key.weight',
        'blocks.1.att.value.weight',
        'blocks.1.att.receptance.weight',
        'blocks.1.att.output.weight',
        'blocks.1.ffn.time_mix',
        'blocks.1.ffn.key.weight',
        'blocks.1.ffn.receptance.weight',
        'blocks.1.ffn.value.weight',
        'blocks.2.ln1.weight',
        'blocks.2.ln1.bias',
        'blocks.2.ln2.weight',
        'blocks.2.ln2.bias',
        'blocks.2.att.time_decay',
        'blocks.2.att.time_first',
        'blocks.2.att.time_mix',
        'blocks.2.att.key.weight',
        'blocks.2.att.value.weight',
        'blocks.2.att.receptance.weight',
        'blocks.2.att.output.weight',
        'blocks.2.ffn.time_mix',
        'blocks.2.ffn.key.weight',
        'blocks.2.ffn.receptance.weight',
        'blocks.2.ffn.value.weight',
        'blocks.3.ln1.weight',
        'blocks.3.ln1.bias',
        'blocks.3.ln2.weight',
        'blocks.3.ln2.bias',
        'blocks.3.att.time_decay',
        'blocks.3.att.time_first',
        'blocks.3.att.time_mix',
        'blocks.3.att.key.weight',
        'blocks.3.att.value.weight',
        'blocks.3.att.receptance.weight',
        'blocks.3.att.output.weight',
        'blocks.3.ffn.time_mix',
        'blocks.3.ffn.key.weight',
        'blocks.3.ffn.receptance.weight',
        'blocks.3.ffn.value.weight',
        'blocks.4.ln1.weight',
        'blocks.4.ln1.bias',
        'blocks.4.ln2.weight',
        'blocks.4.ln2.bias',
        'blocks.4.att.time_decay',
        'blocks.4.att.time_first',
        'blocks.4.att.time_mix',
        'blocks.4.att.key.weight',
        'blocks.4.att.value.weight',
        'blocks.4.att.receptance.weight',
        'blocks.4.att.output.weight',
        'blocks.4.ffn.time_mix',
        'blocks.4.ffn.key.weight',
        'blocks.4.ffn.receptance.weight',
        'blocks.4.ffn.value.weight',
        'blocks.5.ln1.weight',
        'blocks.5.ln1.bias',
        'blocks.5.ln2.weight',
        'blocks.5.ln2.bias',
        'blocks.5.att.time_decay',
        'blocks.5.att.time_first',
        'blocks.5.att.time_mix',
        'blocks.5.att.key.weight',
        'blocks.5.att.value.weight',
        'blocks.5.att.receptance.weight',
        'blocks.5.att.output.weight',
        'blocks.5.ffn.time_mix',
        'blocks.5.ffn.key.weight',
        'blocks.5.ffn.receptance.weight',
        'blocks.5.ffn.value.weight',
        'ln_out.weight',
        'ln_out.bias',
        'head.weight',
        'head_q.weight',
        'head_k.weight'
    ]

    var N_PARAMS = weightName.length
    var LOADED_PARAMS = 0

    // var MODEL_NAME = 'js_model'
    var MODEL_NAME = '20220425'
    document.getElementById("model_version").innerHTML = 'æ¨¡å‹ ' + MODEL_NAME

    var request = new XMLHttpRequest()
    var itos = {}
    var stoi = {}
    request.responseType = 'json';
    request.open('GET', MODEL_NAME + "/word-utf8.json", true)
    request.onload = function () {
        itos = request.response
        for (var key in itos) {
            stoi[itos[key]] = parseInt(key)
        }
    }
    request.send()

    function loadWeight(wName) {
        var request = new XMLHttpRequest()
        request.open('GET', MODEL_NAME + "/" + wName + ".bin", true)
        request.responseType = 'blob'
        request.onload = function () {
            var reader = new FileReader()
            reader.readAsArrayBuffer(request.response)
            reader.onload = function (e) {
                var ww = tf.tensor(new Float32Array(reader.result))

                if ((wName == 'emb.weight') || (wName.includes('head')))
                    ww = ww.reshape([-1, n_embd])
                else if (wName.endsWith('key.weight'))
                    ww = ww.reshape([-1, n_embd])
                else if (wName.endsWith('value.weight'))
                    ww = ww.reshape([n_embd, -1])
                else if (wName.endsWith('receptance.weight') || wName.endsWith('output.weight'))
                    ww = ww.reshape([n_embd, n_embd])

                var xx = wName.split('.')
                var here = gParam
                for (var i = 0; i < xx.length; i++) {
                    if (xx[i] == parseInt(xx[i])) {
                        var ii = parseInt(xx[i])
                        if (!(ii in here))
                            here[ii] = {}
                        here = here[ii]
                    } else {
                        if (i == xx.length - 1)
                            here[xx[i]] = ww
                        else if (!(xx[i] in here)) {
                            here[xx[i]] = {}
                        }
                        here = here[xx[i]]
                    }
                }
                LOADED_PARAMS += 1
                document.getElementById("loadprog").innerHTML = Math.round(LOADED_PARAMS / N_PARAMS * 100) + '%'
                if (LOADED_PARAMS == N_PARAMS) {
                    showBtn()
                    // if (IS_FIRST_RUN)
                    //     sendText()
                }
            }
        }
        request.send()
    }

    function hideBtn() {
        document.getElementById("loading").style.display = "block"
        document.getElementById("writeBtns").style.display = "none"
        document.getElementById("set_prompt").disabled = true
    }

    function showBtn() {
        document.getElementById("loading").style.display = "none"
        document.getElementById("writeBtns").style.display = "flex"
        document.getElementById("set_prompt").disabled = false
    }

    var ln_eps = null
    var const_1 = null
    var xxx = {}
    var aaa = {}
    var bbb = {}
    var hhh = null

    tf.ready().then(() => {
        ln_eps = tf.tensor(1e-5)
        const_1 = tf.ones([n_embd])
        for (var i = 0; i < N_PARAMS; i++) {
            loadWeight(weightName[i])
        }
    });

    function LayerNorm(x, ln) {
        var x_mean = x.mean()
        var x1 = x.sub(x_mean)
        var x_var = x1.square().mean()
        var x_std = (x_var.add(ln_eps)).sqrt()
        x = x1.div(x_std).mul(ln.weight).add(ln.bias)
        return x
    }

    function FF(xx, w, name) {
        if (!(name in xxx)) {
            xxx[name] = tf.zeros([n_embd])
        }
        var x = xx.mul(w.time_mix).add(xxx[name].mul(const_1.sub(w.time_mix)))
        xxx[name].dispose()
        xxx[name] = tf.keep(xx)
        x = x.expandDims(1)

        var r = w.receptance.weight.matMul(x).sigmoid()
        var k = w.key.weight.matMul(x).relu().square()
        var kv = w.value.weight.matMul(k)
        x = r.mul(kv).squeeze()

        return x
    }

    function SA(xx, w, name) {
        if (!(name in xxx)) {
            xxx[name] = tf.zeros([n_embd])
            aaa[name] = tf.zeros([n_embd])
            bbb[name] = tf.zeros([n_embd])
        }
        var x = xx.mul(w.time_mix).add(xxx[name].mul(const_1.sub(w.time_mix)))
        xxx[name].dispose()
        xxx[name] = tf.keep(xx)
        x = x.expandDims(1)

        var r = w.receptance.weight.matMul(x).sigmoid().squeeze()
        var k = w.key.weight.matMul(x).clipByValue(-999999, 60).exp().squeeze()
        var v = w.value.weight.matMul(x).squeeze()
        var kv = k.mul(v)

        var a = aaa[name].add(w.time_first.mul(kv))
        var b = bbb[name].add(w.time_first.mul(k))
        var aa = aaa[name].clone()
        var bb = bbb[name].clone()
        aaa[name].dispose()
        bbb[name].dispose()
        aaa[name] = tf.keep(w.time_decay.mul(aa).add(kv))
        bbb[name] = tf.keep(w.time_decay.mul(bb).add(k))

        var rwkv = r.mul(a).div(b.add(1e-16)).expandDims(1)
        rwkv = w.output.weight.matMul(rwkv).squeeze()

        return rwkv
    }

    function clearStat() {
        xxx = {}
        aaa = {}
        bbb = {}
        hhh = null
    }

    function saveStat(out, name) {
        name = name.slice(-ctx_len)
        ctxBuf[name] = {}
        var buf = ctxBuf[name]
        buf.out = out.slice()
        buf.xxx = {}
        for (var x in xxx) {
            buf.xxx[x] = tf.keep(xxx[x].clone())
        }
        buf.aaa = {}
        for (var x in aaa) {
            buf.aaa[x] = tf.keep(aaa[x].clone())
        }
        buf.bbb = {}
        for (var x in bbb) {
            buf.bbb[x] = tf.keep(bbb[x].clone())
        }
        buf.hhh = tf.keep(hhh.clone())
    }

    function loadStat(name) {
        name = name.slice(-ctx_len)
        var buf = ctxBuf[name]
        for (var x in buf.xxx) {
            xxx[x] = buf.xxx[x].clone()
        }
        for (var x in buf.aaa) {
            aaa[x] = buf.aaa[x].clone()
        }
        for (var x in buf.bbb) {
            bbb[x] = buf.bbb[x].clone()
        }
        hhh = buf.hhh.clone()
        ctxNow = name
        return buf.out.slice()
    }

    function addStat(ctx) {

    }

    function run(ctx) {
        var x = tf.tidy(() => {
            ctx = ctx.slice(-ctx_len)
            var ctxStr = ''
            for (var s of ctx)
                ctxStr += itos[s]
            ctxNow = ctxStr
            // console.log('run', ctxStr)

            var x = gParam.emb.weight.slice(ctx[ctx.length - 1], 1).squeeze()

            x = LayerNorm(x, gParam.blocks[0].ln1)
            x = x.add(FF(x, gParam.blocks[0].ffnPre, '0.ffnPre'))
            x = LayerNorm(x, gParam.blocks[0].ln2)
            x = x.add(FF(x, gParam.blocks[0].ffn, '0.ffn'))

            for (var i = 1; i < 6; i++) {
                x = LayerNorm(x, gParam.blocks[i].ln1)
                x = x.add(SA(x, gParam.blocks[i].att, i + '.att'))
                x = LayerNorm(x, gParam.blocks[i].ln2)
                x = x.add(FF(x, gParam.blocks[i].ffn, i + '.ffn'))
            }
            x = LayerNorm(x, gParam.ln_out)

            x = x.expandDims(1)
            var hk = gParam.head_k.weight.matMul(x).squeeze().expandDims(0)
            // console.log(itos[ctx[ctx.length - 1]], hk.dataSync()[0])
            if (hhh === null) {
                hhh = tf.keep(hk)
            } else {
                var hh = hhh.clone()
                hhh.dispose()
                if (hh.shape[0] >= ctx_len) {
                    hhh = tf.keep(hh.slice(1, -1).concat(hk))
                } else {
                    hhh = tf.keep(hh.concat(hk))
                }
            }

            var q = gParam.head_q.weight.matMul(x)
            var c = hhh.matMul(q).div(256).dataSync()

            x = gParam.head.weight.matMul(x)
            x = x.dataSync()

            // console.log(ctxNow, ctx.length, c.length)
            for (var i = 0; i < ctx.length; i++) {
                x[ctx[i]] += c[i]
                // console.log(i, itos[ctx[i]], hhh.slice(i, 1).dataSync()[0])
            }

            return x
        })
        // console.log(x)
        // console.log(c)
        // console.log(tf.memory())
        return x
    }

    var ctx = [1]
    var ctxBuf = {}
    var ctxNow = ''
    var gWriteShallStop = false

    function asyncWriteOne(iter = 0) {
        if (iter < WRITE_EACH_LENGTH) {
            document.getElementById("loading").innerHTML = 'æ­£åœ¨å†™ ' + (iter + 1) + '/' + WRITE_EACH_LENGTH + ' å­—ï¼Œéšæœºåº¦ ' + TOP_P + ' <button onmousedown="gWriteShallStop=true">ã€åœæ­¢ã€‘</button>'
            setTimeout(() => {

                var ctxStr = ''
                for (var s of ctx)
                    ctxStr += itos[s]

                var out
                if (ctxStr in ctxBuf) {
                    // console.log('find', ctxStr)
                    out = loadStat(ctxStr)
                } else {
                    out = run(ctx)
                    if ((iter == WRITE_EACH_LENGTH - 1) || (gWriteShallStop))
                        saveStat(out, ctxStr)
                }

                var reg = new RegExp("[\\u4E00-\\u9FFF]+", "g");
                var count = {}
                var extra = {}
                for (var j = ctx.length - 1; j >= 0; j--) {
                    var dist = ctx.length - j
                    var cj = ctx[j]
                    var cc = itos[cj]
                    if (cj in count)
                        count[cj] += 1
                    else {
                        count[cj] = 1
                        extra[cj] = 0
                    }
                    extra[cj] += Math.max(0, count[cj] - 1 - dist * (reg.test(cc) ? 0.01 : 0.05))
                }
                for (var j in extra) {
                    out[j] -= Math.pow(extra[j], 1)
                }

                var indexed = Array.from(Array(out.length).keys()).sort((a, b) => out[a] > out[b] ? -1 : (out[b] > out[a]) | 0)

                // var result = indexed[0]

                var sum_exp = 0
                for (var i = 0; i < out.length; i++) {
                    out[i] = Math.exp(out[i])
                    sum_exp += out[i]
                }

                var ran = Math.random() * TOP_P
                var i = 0
                while (true) {
                    // console.log(ran, i, out[indexed[i]] / sum_exp)
                    ran -= out[indexed[i]] / sum_exp
                    if (ran > 0)
                        i += 1
                    else
                        break
                }
                var result = indexed[i]

                addText(itos[result])
                ctx.push(result)

                if (!gWriteShallStop)
                    asyncWriteOne(iter + 1);
                else {
                    localStorage.setItem('txt_stored', textArea.value);
                    localStorage.setItem('log_stored', logArea.value);
                    showBtn()
                }
            }, 0);
        } else {
            localStorage.setItem('txt_stored', textArea.value);
            localStorage.setItem('log_stored', logArea.value);
            showBtn()
        }
    }

    var ANALYZE_LENGTH = 0

    function asyncAnalyze(iter = 1, callback) {
        if ((iter < ANALYZE_LENGTH) && (!gWriteShallStop)) {
            setTimeout(() => {
                var ccc = ctx.slice(0, iter)

                var ctxStr = ''
                for (var s of ccc)
                    ctxStr += itos[s]

                if (ctxStr in ctxBuf) {
                    // console.log('find', ctxStr)
                    loadStat(ctxStr)
                } else {
                    // console.log('ANALYZE', ctxStr)
                    var out = run(ccc)
                    if (iter == ANALYZE_LENGTH - 1)
                        saveStat(out, ctxStr)
                }
                document.getElementById("loading").innerHTML = 'æ­£åœ¨åˆ†ææœ€å ' + iter + '/' + ANALYZE_LENGTH + ' å­—ï¼ˆè¿™æ­¥å¾…ä¼˜åŒ–ï¼Œä»¥åä¼šæé€Ÿ10å€ï¼‰' + ' <button onmousedown="gWriteShallStop=true">ã€åœæ­¢ã€‘</button>'
                asyncAnalyze(iter + 1, callback);
            }, 0);
        } else {
            callback()
        }
    }

    async function write(rawCtx) {
        if (LOADED_PARAMS == N_PARAMS) {
            clearStat()
            hideBtn()
            gWriteShallStop = false
            document.getElementById("loading").innerHTML = 'æ­£åœ¨ç»­å†™...'
            var logArea = document.getElementById("logArea")
            logArea.value += '\n\n'
            var context = ''

            if (rawCtx == '') {
                context = '\n'
            } else {
                var endsNewLine = false
                var rr = rawCtx.split('\n')
                if (rr[rr.length - 1].trim() == '')
                    endsNewLine = true

                rawCtx = rawCtx.trim()
                rawCtx = rawCtx.replaceAll('\r\n', '\n').replaceAll('ã€€', ' ')
                rawCtx = rawCtx.split('\n')
                for (var i = 0; i < rawCtx.length; i++) {
                    var ss = rawCtx[i].trim()
                    if (ss.length > 0)
                        context += '\n' + ss
                }
                if (endsNewLine)
                    context = context + '\n'
            }
            var context_shifted = context.slice(-ctx_len - 1, -1)
            context = context.slice(-ctx_len)
            // console.log(context)
            ctx = Array.prototype.map.call(context, x => {
                if (x in stoi)
                    return stoi[x];
                else {
                    return -1;
                }
            })
            var badindex = ctx.indexOf(-1)
            if (badindex >= 0) {
                document.getElementById("loading").innerHTML = 'å†…å®¹æœ‰ä¸è§„èŒƒå­—ç¬¦ [' + context[badindex] + ']ï¼Œè¯·ä½¿ç”¨ç®€ä½“å’ŒåŠè§’è‹±æ–‡æ•°å­—ã€‚'
                setTimeout(() => {
                    showBtn()
                }, 1000)
                return
            }

            // console.log(context, context_shifted, JSON.stringify(Object.keys(ctxBuf)))
            if (context.slice(-ctx_len) in ctxBuf) {
                // console.log('find', context)
                loadStat(context)
                asyncWriteOne()
            } else if (context_shifted in ctxBuf) {
                // console.log('find-shifted', context_shifted, 'ctx', context, ctx)
                loadStat(context_shifted)
                asyncWriteOne()
            } else {
                ANALYZE_LENGTH = ctx.length
                asyncAnalyze(1, asyncWriteOne)
            }
        }
    }

    //=================================================================================================

    var textArea = document.getElementById("textArea")
    var logArea = document.getElementById("logArea")

    var IS_FIRST_RUN = false

    let txt_stored = localStorage.getItem('txt_stored');
    if (txt_stored) {
        textArea.value = txt_stored
    } else {
        IS_FIRST_RUN = true
    }

    let log_stored = localStorage.getItem('log_stored');
    if (log_stored)
        logArea.value = log_stored

    let lastGeneratePosition = -1
    textArea.scrollTop = textArea.scrollHeight;
    logArea.scrollTop = logArea.scrollHeight;

    function addText(d) {
        textArea.value += d
        textArea.scrollTop = textArea.scrollHeight;

        logArea.value += d
        logArea.scrollTop = logArea.scrollHeight;
    }

    textArea.onchange = function (e) {
        localStorage.setItem('txt_stored', textArea.value);
    }
    textArea.oninput = function (e) {
        localStorage.setItem('txt_stored', textArea.value);
    }
    logArea.onchange = function (e) {
        localStorage.setItem('log_stored', logArea.value);
    }
    logArea.oninput = function (e) {
        localStorage.setItem('log_stored', logArea.value);
    }

    function sendText() {
        if (document.getElementById("loading").style.display != "none")
            return
        let txt = document.getElementById("textArea").value
        lastGeneratePosition = txt.length
        // let msg = txt.substr(Math.max(0, txt.length - 767))
        // console.log(msg)
        write(txt)
    }

    function rewriteText() {
        let txt = document.getElementById("textArea").value
        if (lastGeneratePosition == -1) {
            if (txt.length == 0)
                lastGeneratePosition = 0
        }
        if (lastGeneratePosition != -1) {
            txt = txt.substr(0, lastGeneratePosition)
            document.getElementById("textArea").value = txt
        }
        sendText()
    }

    function setPrompt(pp) {
        if (pp.includes('é€‰æ‹©'))
            return
        document.getElementById("set_prompt").selectedIndex = 0
        logArea.value += '\n\n' + textArea.value
        logArea.scrollTop = logArea.scrollHeight
        textArea.value = pp
        window.scrollTo(0, 0)
        sendText()
    }

    document.onkeydown = function (event) {
        if (event.altKey) {
            if (event.keyCode === 81) {
                sendText()
                return false
            }
            if (event.keyCode === 69) {
                rewriteText()
                return false
            }
        }
    }
</script>

</html>
